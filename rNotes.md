记录一些学习笔记
===============


一个块（逻辑概念），默认大小是200MB，因为考虑数据移动开销很大，而200MB是性能和最小开销的最佳选择。
平衡器，可以把一个分片自动迁移到另外一个分片，需要确定3.0中的算法是否“智能”？
一个分片必须必最少的块的分片多出至少9个块，才会触发平衡器。9个块，也就1.8GB，看上去也没那么不平衡吧。
这样做就可以极大化减少数据“无意义”移动。一点轻微的不平衡就不需要移动，因为这种移动往往是徒劳滴。
在开发环境，可以在启动mongos时通过--chunksize N 指定块大小，其中N单位是MB。这样就可以“满足”你的眼睛，
让你看到数据在移动了。
在生产环境，坚决不能去改动chunksize的默认值。


插入和查询包含片键，mongos会发送到特定分片。否则，就必须发送到所有分片。


配置服务器--跟踪集群状态和维护基本配置项，必须全部健康在线活着，不然当前正在执行的所有迁移都会回退并停止。任何一台配置服务器罢工了，
集群配置都无法改变。


mongos进程通常跑在应用服务器上，配合服务器，鉴于其重要性，轻量性，基本可以在任何机器上运行。每个分片通常有
多台服务器组成，因为他们要负责实际存储。

选择片键----头等大事
----------------------
##反面教材：
1，用有限的可能值N（少于4，6）做片键。如果你这么做了，恭喜你，只能买最最大的磁盘了。
最终也就最多N个片了。但是如果在此字段做大量查询，请使用组合片键，并确保第二个字段有
N+M个不同的值供mongo去分片。

如果一个集合有生命周期（在这个周期内，数据量不会接近任何分片的最大容量），那就用这个生命周期作为片键。
虽然可以，但是业务也有井喷的时候，还是头疼。

所以在   数据中心感知  出道之前，最好不要选择小基数片键。

2，顺序片键，如时间戳，Objectid, 自增主键（从其他数据库导入）按照这个模式持续下去，所有数据总是被添加到“最后”
一个数据块上，即，所有数据都会被添加到一个分片上。
这个片键创造了一个单一且不可分散的热点。

3，随机片键，有时为了避免热点，可能会选择一个取值随机的字段作为片键，刚开始感觉
很好，but数据量越来愈大，它就会越来越慢！当块数据差大于9个了，配置服务器
触发自动迁移数据，就需要把5个块的数据从磁盘加载到内存中，产生大量磁盘io。

4，好的片键，具备良好的数据局部性，但又不会因为太局部而导致热点出现。
1）准升序键加搜索键，像{xxxxx：1， search：1}，其中xxxxx的键值最好能对应几十到
几百的数据块，而search键测试通常用来做查询的且具备非升序，分布随机且技术适当。


考虑出发点：
----------
读写操作是怎么样的？有多大访问量，比例如何？
每小时读写多少数据？每天呢？高峰期呢？
数据做索引了吗？应不应该索引呢？
数据总量有多大？

配置服务器：测试环境一个，两个就显得多了，生产环境3个，2个就显得少了。
不能运行任意数目配置服务器，因为他们之间的通讯是复杂的！
尽可能部署在不同的domain（数据中心）里，保障他们都很好地活着。


限制分片大小：默认系统MongoDB会在分片间均匀数据，but你的服务器物理配置差别很大
，那就需要使用maxSize选项，单位MB。
但是maxSize更像是建议，而非规定。MongoDB并不会在maxSize处截断一个分片，或者阻止
它再增加哪怕一个字节而是会停止将数据移动该分片上。当然了 ，它可能还会移走部分数据呢。

####
如果对一个已经包含数据的集合进行分片，数据片键上必须有索引，所有这些文档也都必须有片键（且不能为null）。
在集合分片完成后，才可以插入片键值为null的文档。
在还有较多容量时，提前做分片，不然就要凌晨3点了。。。。


移除分片，过早使用分片或者选择错的片键。在分片间移动数据非常耗时，removeShard
命令会立即返回，你必须轮训查看操作是否已经完成。


###集群###
1，在分片集合进行计数count时，如果有一个迁移正在进行，许多文档就会同事存在多个分片上。
最后一步，MingoDB才会更新配置服务器并删除原来分片上的数据副本。这样一来，count就变大了。
2，唯一索引，假设在email字段进行分片，同时在username上添加唯一索引，在集群中不能强制实施。
因为，插入数据时整个集群没有此数据，可以插入。但是在这个时候，另一个包含同样唯一索引的数据过来
了，集群查找后，任然发现可以插入，好，那就各自插入吧。这样就呵呵了~@~
唯一方法是锁住整个集群，但是高性能写入就难以保证了。因此，除片键以外任何键都难以保证唯一性。
于此，我们推出一个有趣结论：除非在_id上分片，否则就可能出现不唯一的_id。
3，更新，默认只针对单个文档，它和唯一索引一样面临同样问题，即没有好办法确保操作
在多个分片间只发生一次。故，如果想更新单个文档，就一定要在条件中使用片键作为update的
第一个参数。
4，MapReduce，不适合做实时运算。

###管理###
1，应该连接什么，正常的读写，管理类操作，答案永远是mongos。
2，监控？？
3，在某个mongos节点上运行mongostat --discover。
4，备份，选择性去把需要恢复的这些块，如果想要对整个集群做快照，那就必须关闭平衡器
，fsync并锁住集群中所有从机，转储，然后解锁并重启平衡器。但通常我们都是从部分分片上提取备份。
5，关于架构的建议：
1）虚拟皇家御林军---搞一个队列接收计划中断期间的请求，等到mongos启动后，再发送过去。
2）错误处理---应用程序要处理一些必要异常，如分片停机。
3）多数分片停机---如果用了副本集做分片，则一般不会全部停机，但是副本集失去了多数成员，则
没有服务器能成为主机，集合就变成只读状态。一旦这样了，就需要带有slaveOkay的选项读请求。
4）配置服务器停机---任何一台配置服务器停机并不会立即对集群的性能产生影响，但是
会导致无法修改任何配置了（不能添加mongos服务器、不能迁移数据（迁移数据最后几步就是更新配置服务器，如坏了，则退回迁移并删除复制完成的所有数据）、
不能添删数据库或集合、不能修改副本集的配置）。所以请务必要监控《配置服务器》。
5）mongos进程死掉---无状态且不保存数据，死了尝试就地拉起来。也可以用驱动程序提供的
一组可连接的服务器特性，把备胎mongos放在此列表后面。让她安静地做个备胎。



测试数据库备份的性能、稳定性、完整性：有/无查询单表、单集合、整个集群做快照。

#备注：选择性去把需要恢复的这些块，如果想要对整个集群做快照，那就必须关闭平衡器
  ，fsync并锁住集群中所有从机，转储，然后解锁并重启平衡器。但通常我们都是从部分分片上提取备份。
